<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Miriele Admin Panel</title>
  <style>
    body { font-family: sans-serif; background: #111827; color: white; margin: 0; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn { padding: 8px 16px; background: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #messages { max-height: 600px; overflow-y: auto; background: #1f2937; padding: 10px; border-radius: 5px; }
    .message { padding: 8px; border-bottom: 1px solid #374151; }
    .message span { font-size: 0.85em; color: #9ca3af; }
    .admin-actions button { margin-left: 10px; font-size: 0.8em; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel</h1>
    <div>
      <a href="index.html" class="btn">Home</a>
      <button id="logout" class="btn">Logout</button>
    </div>
  </header>

  <div id="messages"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut,
      GoogleAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getDatabase,
      ref,
      onChildAdded,
      onChildRemoved,
      remove,
      update
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB4w6elulTE2FJbJVAXNUYs74_YC1Ti6yQ",
      authDomain: "mirielechat.firebaseapp.com",
      projectId: "mirielechat",
      storageBucket: "mirielechat.appspot.com",
      messagingSenderId: "1031331000258",
      appId: "1:1031331000258:web:7cae47f29cb3493fb1f05b",
      databaseURL: "https://mirielechat-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const messagesRef = ref(db, 'messages');

    const logoutBtn = document.getElementById("logout");
    logoutBtn.onclick = () => signOut(auth);

    const allowedAdmins = ["monday1379@gmail.com"];

    function isAdmin(email) {
      return allowedAdmins.includes(email);
    }

    function renderMessage(id, msg) {
      if (document.getElementById(`msg-${id}`)) return; // Avoid duplicates

      const container = document.createElement("div");
      container.className = "message";
      container.id = `msg-${id}`;
      container.innerHTML = `
        <strong>${msg.name || "Anonymous"}</strong>: ${msg.text}
        <span>${new Date(msg.timestamp).toLocaleString()}</span>
        <div class="admin-actions">
          <button onclick="deleteMessage('${id}')">ðŸ—‘ Delete</button>
          <button onclick="banUser('${msg.uid}')">ðŸš« Ban</button>
        </div>
      `;
      document.getElementById("messages").prepend(container);
    }

    window.deleteMessage = async (id) => {
      await remove(ref(db, `messages/${id}`));
      const el = document.getElementById(`msg-${id}`);
      if (el) el.remove();
    };

    window.banUser = async (uid) => {
      await update(ref(db, 'banned/' + uid), { banned: true });
      alert('User banned');
    };

    onAuthStateChanged(auth, user => {
      if (user && isAdmin(user.email)) {
        // Load and listen to messages
        onChildAdded(messagesRef, snapshot => {
          const msg = snapshot.val();
          renderMessage(snapshot.key, msg);
        });

        onChildRemoved(messagesRef, snapshot => {
          const el = document.getElementById(`msg-${snapshot.key}`);
          if (el) el.remove();
        });

      } else {
        alert("Unauthorized. Redirecting to homepage.");
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
