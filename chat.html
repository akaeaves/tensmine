<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Miriele Chatroom</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 0;
    }
    header {
      background: #111;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header a, header button {
      color: #fff;
      text-decoration: none;
      margin-left: 1rem;
      background: #333;
      border: none;
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 5px;
    }
    #chatbox {
      padding: 1rem;
      max-width: 800px;
      margin: 0 auto;
    }
    #messages {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #444;
      padding: 1rem;
      background: #222;
      margin-bottom: 1rem;
    }
    #input-area {
      display: flex;
      gap: 0.5rem;
    }
    input, button {
      padding: 0.5rem;
    }
    .message {
      margin-bottom: 0.5rem;
    }
    .timestamp {
      font-size: 0.8rem;
      color: #aaa;
    }
  </style>
</head>
<body>

<header>
  <a href="index.html">Home</a>
  <div id="authControls"></div>
</header>

<main id="chatbox" style="display:none;">
  <div id="messages"></div>
  <div id="input-area">
    <input type="text" id="messageInput" placeholder="Type a message" />
    <button id="sendBtn">Send</button>
  </div>
</main>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signOut,
    signInWithPopup,
    GoogleAuthProvider
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    onChildAdded
  } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB4w6elulTE2FJbJVAXNUYs74_YC1Ti6yQ",
    authDomain: "mirielechat.firebaseapp.com",
    projectId: "mirielechat",
    databaseURL: "https://mirielechat-default-rtdb.firebaseio.com",
    storageBucket: "mirielechat.appspot.com",
    messagingSenderId: "1031331000258",
    appId: "1:1031331000258:web:7cae47f29cb3493fb1f05b"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);
  const provider = new GoogleAuthProvider();

  const authControls = document.getElementById("authControls");
  const chatbox = document.getElementById("chatbox");
  const messagesDiv = document.getElementById("messages");
  const messageInput = document.getElementById("messageInput");
  const sendBtn = document.getElementById("sendBtn");

  onAuthStateChanged(auth, (user) => {
    if (user) {
      authControls.innerHTML = `
        <span>Logged in as: ${user.displayName || user.email}</span>
        <button id="logoutBtn">Logout</button>
      `;
      document.getElementById("logoutBtn").onclick = () => {
        signOut(auth);
      };
      chatbox.style.display = "block";
      loadMessages(user);
    } else {
      chatbox.style.display = "none";
      authControls.innerHTML = `
        <button id="googleLoginBtn">Sign in with Google</button>
      `;
      document.getElementById("googleLoginBtn").onclick = () => {
        signInWithPopup(auth, provider).catch(err => alert(err.message));
      };
    }
  });

  sendBtn.onclick = () => {
    const user = auth.currentUser;
    const text = messageInput.value.trim();
    if (!text) return;

    push(ref(db, "messages"), {
      uid: user.uid,
      email: user.email,
      name: user.displayName,
      text,
      timestamp: Date.now()
    });

    messageInput.value = "";
  };

  function loadMessages(user) {
    messagesDiv.innerHTML = "";
    onChildAdded(ref(db, "messages"), (snapshot) => {
      const msg = snapshot.val();
      const time = new Date(msg.timestamp).toLocaleTimeString();
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<strong>${msg.name || msg.email}:</strong> ${msg.text} <span class="timestamp">(${time})</span>`;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });
  }
</script>

</body>
</html>
